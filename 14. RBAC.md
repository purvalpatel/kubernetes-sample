RBAC  ( Role Based Access Control ) :
---------------------------------------
- Who can do what in yout kubernetes cluster.

**Who** - user, group and service account. <br>
**What** - resources like pod, services, deployments.<br>
**Actions** - get, list, create, update, delete. <br>

Think of it like giving permissions to users, services accounts or groups. <br>

For e.g. only admins to create or delete resources. <br>

Only developers to deploy apps. <br>
Only monitoring tools can read logs. <br>

RBAC is made of 4 parts: <br>
1. Role:		can read pods <br>
2. ClusterRole:		can read nodes 
3. RoleBinding:	dev can read pods in dev-ns

Mostly this is used from the Gitlab CI, Jenkins. <br>
Verify the RBAC is enabled or not. <br>
```
ps -ef | grep kube-apiserver | grep authorization-mode
```

1. Create namespace:
```
kubectl create namespace dev
```

2. Create role (developer access):
dev-role.yaml <br>

Role - Role always set permission with namespace. <br>
ClusterRole - Non namespaced resources. <br>

```
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: dev-role
  namespace: dev
rules:
- apiGroups: [""]  # Core resources
  resources: ["pods", "services", "configmaps", "secrets"]
  verbs: ["get", "list", "watch", "create", "update", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch", "create", "update", "delete"]
```

Apply changes:
```
kubectl apply -f dev-role.yaml
```
OR
```
kubectl apply -f https://raw.githubusercontent.com/purvalpatel/kubernetes-sample/main/dev-role.yaml
```

3.Create service account:
```
kubectl create serviceaccount dev -n dev
```

Delete service account:
```
kubectl delete serviceaccount dev -n dev
```

4.Bind role to serviceaccount:
dev-rolebinding.yaml
```
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dev-binding
  namespace: dev
subjects:
- kind: ServiceAccount
  name: dev
  namespace: dev
roleRef:
  kind: Role
  name: dev-role
  apiGroup: rbac.authorization.k8s.io
```
```
kubectl apply -f dev-rolebinding.yaml
```
OR
```
kubectl apply -f https://raw.githubusercontent.com/purvalpatel/kubernetes-sample/main/dev-rolebinding.yaml
```

5.Get the service account token:
```
kubectl -n <namespace> create token <service-account-name>
kubectl -n dev create token dev
```

Note: This token is not stored anywhere. So it is not retrievable. And this is token is generated for short time. It will expired. <br>
To create long lived token we have to provide duration parameter. <br>
```
kubectl -n dev create token dev --duration=14h
```

6.Create cluster and context:

```
kubectl config set-cluster dev-cluster \
  --server=https://10.7.10.23:6443 \
  --insecure-skip-tls-verify=true

kubectl config set-context dev-context \
  --cluster=dev-cluster \
  --user=dev-user \
  --namespace=dev-ns
```

Note: <br>
- Here --user=dev-user is not referring to any kubernetes user or service account. <br>
It referes to the entry in your kubeconfigs users section.	<br>
- You dont need to create kubernetes users manually when you are using kubeadm. Instead of this use serviceaccounts. <br>


7.provide this yaml to developers, this should be done in developers machine: <br>
#~./kube/config

```
apiVersion: v1
kind: Config
clusters:
- name: kubernetes
  cluster:
    server: https://kube.nuvoai.io
    insecure-skip-tls-verify: true

contexts:
- name: dev-context
  context:
    cluster: kubernetes
    namespace: dev
    user: dev

current-context: dev-context

users:
- name: dev
  user:
token: <token>
```

**Note**: here user, **dev** is not the kubernetes user it is just reference in below section of token. <br>

Before that set reverse proxy of kubernetes cluster machine: <br>

/etc/nginx/conf.d/ssl.conf
```
server {
    listen 443 ssl;
    server_name kube.nuvoai.io;

    ssl_certificate /etc/nginx/ssl/nuvoai.io/crt.crt;
    ssl_certificate_key /etc/nginx/ssl/nuvoai.io/crt.key;

    # Error pages configuration
    error_page 404 403 500 503 502 /error-page.html;

    location = /error-page.html {
        root /var/www/html;
        internal;
    }

    location / {
        proxy_pass https://10.7.10.23:6443;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}
```

8. Now developers will run this from their machine:
```
kubectl get pods --namespace=dev
```

developers can create pods on cluster from their machine:
```
kubectl apply -f https://raw.githubusercontent.com/purvalpatel/kubernetes-sample/main/nginx-deployment.yaml
```

This will create pods on kubernetes cluster.
```
kubectl get pods --namespace=dev
```

Delete the setup:
1.Remove role binding:
```
kubectl delete rolebinding dev-binding -n dev
```
2.Remove role:
```
kubectl delete role dev -n dev
```

3.Remove service account:
```
kubectl delete serviceaccount dev -n dev
```
